name: üöÄ VS CODE WEB IDX (ZUN ADMIN - TOTAL FIX)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  VSCode-ZunAdmin:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è KH·ªûI T·∫†O H·ªÜ TH·ªêNG BI·ªÜT L·∫¨P
        run: |
          sudo hostnamectl set-hostname ZunAdmin
          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin

          # T·∫°o v√† Mount ·ªï 60GB
          sudo fallocate -l 60G /mnt/zun_storage.img
          sudo mkfs.ext4 /mnt/zun_storage.img > /dev/null 2>&1
          sudo mount -o loop /mnt/zun_storage.img /home/Admin
          sudo mkdir -p /home/Admin/.config/code-server
          sudo cp /etc/skel/.bashrc /home/Admin/
          sudo chown -R Admin:Admin /home/Admin

          # C√†i ƒë·∫∑t Code-Server
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1
          sudo -u Admin bash -c "cat <<EOF > /home/Admin/.config/code-server/config.yaml
          bind-addr: 127.0.0.1:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF"

          # Ch·∫°y VS Code & Tunnel
          sudo -u Admin nohup code-server > /home/Admin/code_server.log 2>&1 &
          
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          
          # Ch·∫°y tunnel kh√¥ng buffer ƒë·ªÉ cat ƒë·ªçc ƒë∆∞·ª£c ngay
          stdbuf -o0 ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: üéâ TH√îNG TIN TRUY C·∫¨P (FINAL FIX)
        run: |
          echo "üì° ƒêang b√≥c t√°ch IP t·ª´ kami_tunnel.txt..."
          sleep 15
          
          # L·ªánh Cat v√† tr√≠ch xu·∫•t IP chu·∫©n theo ·∫£nh 1325
          # T√¨m d√≤ng ch·ª©a Public, l·∫•y c·ªôt th·ª© 3 (ph√¢n c√°ch b·ªüi d·∫•u c√°ch ho·∫∑c g·∫°ch ƒë·ª©ng)
          RAW_IP=$(cat kami_tunnel.txt | grep "Public:" | tail -n 1 | awk '{print $3}')
          
          if [ -z "$RAW_IP" ]; then
            echo "‚ùå V·∫´n ch∆∞a th·∫•y IP. N·ªôi dung file ƒëang c√≥ l√†:"
            cat kami_tunnel.txt
            exit 1
          fi

          # HI·ªÇN TH·ªä LOG SI√äU ƒê·∫∏P
          echo ""
          echo -e "\033[1;33m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\033[0m"
          echo -e "\033[1;32m  üöÄ VS CODE WEB IDX ƒê√É S·∫¥N S√ÄNG!\033[0m"
          echo -e "\033[1;33m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\033[0m"
          echo -e "\033[1;36m  üåê ƒê·ªäA CH·ªà IP   :\033[0m \033[1;37mhttp://$RAW_IP\033[0m"
          echo -e "\033[1;36m  üë§ T√ÄI KHO·∫¢N     :\033[0m \033[1;37mAdmin\033[0m"
          echo -e "\033[1;36m  üîê M·∫¨T KH·∫®U      :\033[0m \033[1;37mUbuntu@123456\033[0m"
          echo -e "\033[1;33m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\033[0m"
          echo -e "\033[1;32m  üíæ DUNG L∆Ø·ª¢NG    : 60GB (Isolated System)\033[0m"
          echo -e "\033[1;33m‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\033[0m"
          echo ""
          echo "WEB_LINK=http://$RAW_IP" >> $GITHUB_ENV

      - name: ‚è≥ DUY TR√å
        run: |
          for i in {1..100}; do
            echo -e "\033[1;34müíé [$(date +%T)] Ho·∫°t ƒë·ªông: $WEB_LINK\033[0m"
            sleep 300
          done
