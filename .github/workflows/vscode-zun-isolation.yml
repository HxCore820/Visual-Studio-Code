name: ğŸš€ VS CODE WEB IDX (ZUN ADMIN - IP FIX)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  VSCode-ZunAdmin:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ KHá»I Táº O Há»† THá»NG BIá»†T Láº¬P
        run: |
          sudo hostnamectl set-hostname ZunAdmin
          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin

          # Táº¡o vÃ  Mount á»• 60GB
          sudo fallocate -l 60G /mnt/zun_storage.img
          sudo mkfs.ext4 /mnt/zun_storage.img > /dev/null 2>&1
          sudo mount -o loop /mnt/zun_storage.img /home/Admin
          sudo mkdir -p /home/Admin/.config/code-server
          sudo cp /etc/skel/.bashrc /home/Admin/
          sudo chown -R Admin:Admin /home/Admin

          # CÃ i Ä‘áº·t Code-Server
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1
          sudo -u Admin bash -c "cat <<EOF > /home/Admin/.config/code-server/config.yaml
          bind-addr: 127.0.0.1:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF"

          # Cháº¡y VS Code & Tunnel
          sudo -u Admin nohup code-server > /home/Admin/code_server.log 2>&1 &
          
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          
          # DÃ¹ng stdbuf Ä‘á»ƒ Ä‘áº£m báº£o cat Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u ngay
          stdbuf -o0 ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: ğŸ‰ THÃ”NG TIN TRUY Cáº¬P (IP:PORT MODE)
        run: |
          echo "ğŸ“¡ Äang trÃ­ch xuáº¥t IP tá»« kami_tunnel.txt..."
          sleep 12
          
          # Äá»c file, tÃ¬m dÃ²ng Public, láº¥y pháº§n IP:Port (bá» cÃ¡c kÃ½ tá»± | vÃ  khoáº£ng tráº¯ng)
          RAW_IP=$(cat kami_tunnel.txt | grep "Public:" | head -n 1 | awk -F'Public:' '{print $2}' | tr -d ' |')
          
          if [ -z "$RAW_IP" ]; then
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y IP. Ná»™i dung file hiá»‡n táº¡i Ä‘á»ƒ báº¡n check:"
            cat kami_tunnel.txt
            exit 1
          fi

          echo ""
          echo -e "\033[1;32mâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\033[0m"
          echo -e "\033[1;32mâ•‘\033[0m \033[1;36mğŸŒ Äá»ŠA CHá»ˆ IP   :\033[0m http://$RAW_IP"
          echo -e "\033[1;32mâ•‘\033[0m \033[1;36mğŸ‘¤ USERNAME     :\033[0m Admin"
          echo -e "\033[1;32mâ•‘\033[0m \033[1;36mğŸ” PASSWORD     :\033[0m Ubuntu@123456"
          echo -e "\033[1;32mâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\033[0m"
          echo -e "\033[1;32mâ•‘\033[0m \033[1;33mğŸ’¾ Bá»˜ NHá»š       :\033[0m 60GB SSD (Isolated)"
          echo -e "\033[1;32mâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\033[0m"
          echo "WEB_LINK=http://$RAW_IP" >> $GITHUB_ENV

      - name: â³ DUY TRÃŒ
        run: |
          for i in {1..100}; do
            echo "ğŸ’ [$(date +%T)] IP ÄANG CHáº Y: $WEB_LINK"
            sleep 300
          done
