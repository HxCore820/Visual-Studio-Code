name: üöÄ VS Code Web IDX (Zun Admin Isolation)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  VSCode-ZunAdmin:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è KH·ªûI T·∫†O M√îI TR∆Ø·ªúNG ZUN (ISOLATED)
        run: |
          # 1. Thi·∫øt l·∫≠p Hostname
          sudo hostnamectl set-hostname ZunMachine
          echo "127.0.0.1 ZunMachine" | sudo tee -a /etc/hosts > /dev/null

          # 2. T·∫°o User 'Admin'
          echo "üë§ ƒêang t·∫°o User Admin..."
          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin

          # 3. T·∫°o ·ªï c·ª©ng ·∫£o 60GB
          echo "üíø ƒêang kh·ªüi t·∫°o ·ªï c·ª©ng 60GB..."
          sudo fallocate -l 60G /mnt/zun_storage.img
          sudo mkfs.ext4 /mnt/zun_storage.img > /dev/null 2>&1
          
          # 4. Mount ·ªï c·ª©ng v√†o ch√≠nh Home c·ªßa Admin
          sudo mount -o loop /mnt/zun_storage.img /home/Admin
          sudo chown -R Admin:Admin /home/Admin
          sudo chmod 755 /home/Admin

          # 5. C√†i ƒë·∫∑t VS Code Web (Code-Server)
          echo "üì• ƒêang c√†i ƒë·∫∑t Code-Server..."
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1

          # 6. C·∫•u h√¨nh VS Code (Ch·∫°y d∆∞·ªõi quy·ªÅn Admin)
          sudo -u Admin mkdir -p /home/Admin/.config/code-server
          
          # T·∫°o config
          sudo -u Admin bash -c 'cat <<EOF > /home/Admin/.config/code-server/config.yaml
          bind-addr: 127.0.0.1:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF'

          # Tinh ch·ªânh l·ªánh df -h ƒë·ªÉ ch·ªâ hi·ªán ·ªï c·ªßa m√¨nh (t·∫°o c·∫£m gi√°c ri√™ng bi·ªát)
          sudo -u Admin bash -c 'echo "alias df=\"df -h | grep -E 'Filesystem|/home/Admin'\"" >> /home/Admin/.bashrc'
          sudo cp /etc/skel/.bashrc /home/Admin/
          sudo chown Admin:Admin /home/Admin/.bashrc

          # 7. Kh·ªüi ch·∫°y VS Code (Admin)
          echo "üöÄ ƒêang kh·ªüi ƒë·ªông VS Code..."
          sudo -u Admin nohup code-server > /home/Admin/code-server.log 2>&1 &

          # 8. Ch·∫°y Tunnel
          echo "üåê ƒêang thi·∫øt l·∫≠p Tunnel..."
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: üéâ TH√îNG TIN TRUY C·∫¨P (GIAO DI·ªÜN VIP)
        run: |
          echo "üîÑ ƒêang l·∫•y li√™n k·∫øt..."
          sleep 5
          WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          
          while [ -z "$WEB_URL" ]; do
            sleep 2
            WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          done

          # GIAO DI·ªÜN LOG M√ÄU RGB SI√äU ƒê·∫∏P
          echo ""
          echo -e "\033[1;35m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\033[0m"
          echo -e "\033[1;35m‚ïë\033[0m   üöÄ \033[1;36mZUN ISOLATED ENVIRONMENT - VS CODE IDX\033[0m            \033[1;35m‚ïë\033[0m"
          echo -e "\033[1;35m‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\033[0m"
          echo -e "\033[1;35m‚ïë\033[0m \033[1;33müåê URL TRUY C·∫¨P  :\033[0m \033[4;32m $WEB_URL \033[0m"
          echo -e "\033[1;35m‚ïë\033[0m \033[1;33müë§ T√ÄI KHO·∫¢N     :\033[0m \033[1;37mAdmin\033[0m"
          echo -e "\033[1;35m‚ïë\033[0m \033[1;33müîê M·∫¨T KH·∫®U      :\033[0m \033[1;37mUbuntu@123456\033[0m"
          echo -e "\033[1;35m‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\033[0m"
          echo -e "\033[1;35m‚ïë\033[0m \033[1;34müíª H·ªÜ TH·ªêNG      :\033[0m \033[1;37mBi·ªát l·∫≠p (Isolated Mode)\033[0m         \033[1;35m‚ïë\033[0m"
          echo -e "\033[1;35m‚ïë\033[0m \033[1;34müíø DUNG L∆Ø·ª¢NG    :\033[0m \033[1;37m60GB SSD (T·∫°i /home/Admin)\033[0m       \033[1;35m‚ïë\033[0m"
          echo -e "\033[1;35m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\033[0m"
          echo ""
          echo "WEB_LINK=$WEB_URL" >> $GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN ZUNADMIN
        run: |
          echo -e "\033[1;32m‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng s·ª≠ d·ª•ng!\033[0m"
          for i in {1..72}; do
            sleep 300
          done
