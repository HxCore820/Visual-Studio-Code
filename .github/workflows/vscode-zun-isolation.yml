Name: ğŸš€ VS Code Web IDX (Zun Admin Isolation)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  VSCode-ZunAdmin:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ KHá»I Táº O MÃ”I TRÆ¯á»œNG ZUN (ISOLATED)
        run: |
          # 1. Thiáº¿t láº­p Hostname
          sudo hostnamectl set-hostname ZunMachine
          echo "127.0.0.1 ZunMachine" | sudo tee -a /etc/hosts > /dev/null

          # 2. Táº¡o User 'Admin' vÃ  Group
          echo "ğŸ‘¤ Äang táº¡o User Admin..."
          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin

          # 3. Táº¡o á»• cá»©ng áº£o 60GB (Zun Storage)
          echo "ğŸ’¿ Äang khá»Ÿi táº¡o á»• cá»©ng 60GB..."
          sudo fallocate -l 60G /mnt/zun_storage.img
          sudo mkfs.ext4 /mnt/zun_storage.img > /dev/null 2>&1
          
          # 4. Mount á»• cá»©ng vÃ o chÃ­nh Home cá»§a Admin (/home/Admin)
          # LÆ°u Ã½: Backup file gá»‘c cá»§a user má»›i táº¡o trÆ°á»›c khi mount (náº¿u cáº§n)
          sudo mount -o loop /mnt/zun_storage.img /home/Admin
          
          # Cáº¥p quyá»n sá»Ÿ há»¯u á»• cá»©ng cho Admin
          sudo chown -R Admin:Admin /home/Admin
          sudo chmod 755 /home/Admin

          # 5. CÃ i Ä‘áº·t VS Code Web (Code-Server)
          echo "ğŸ“¥ Äang cÃ i Ä‘áº·t Code-Server..."
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1

          # 6. Cáº¥u hÃ¬nh VS Code cho user Admin (Cháº¡y dÆ°á»›i quyá»n Admin)
          sudo -u Admin mkdir -p /home/Admin/.config/code-server
          sudo -u Admin bash -c 'cat <<EOF > /home/Admin/.config/code-server/config.yaml
          bind-addr: 127.0.0.1:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF'

          # 7. Tinh chá»‰nh mÃ´i trÆ°á»ng (Fake df -h cho cáº£m giÃ¡c Pro)
          # Khi gÃµ df -h chá»‰ hiá»‡n á»• cá»§a mÃ¬nh vÃ  root tá»‘i giáº£n
          sudo -u Admin bash -c 'echo "alias df=\"df -h | grep -E 'Filesystem|/home/Admin'\"" >> /home/Admin/.bashrc'
          
          # 8. Khá»Ÿi cháº¡y VS Code dÆ°á»›i user Admin
          echo "ğŸš€ Äang khá»Ÿi Ä‘á»™ng VS Code..."
          sudo -u Admin nohup code-server > /home/Admin/code-server.log 2>&1 &

          # 9. Táº£i vÃ  cháº¡y Kami Tunnel
          echo "ğŸŒ Äang thiáº¿t láº­p Tunnel..."
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: ğŸ‰ THÃ”NG TIN TRUY Cáº¬P (USER: ADMIN)
        run: |
          echo "ğŸ”„ Äang láº¥y liÃªn káº¿t..."
          sleep 5
          WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          
          # Fallback náº¿u chÆ°a báº¯t Ä‘Æ°á»£c link ngay
          while [ -z "$WEB_URL" ]; do
            sleep 2
            WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          done

          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ ğŸš€ VS CODE WEB IDX - ISOLATED EDITION              â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸŒ URL      : $WEB_URL"
          echo "â”‚ ğŸ‘¤ User     : Admin"
          echo "â”‚ ğŸ” Password : Ubuntu@123456"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸ’¾ Storage  : 60GB (Mounted at /home/Admin)      â”‚"
          echo "â”‚ ğŸ›¡ï¸ Mode     : User Isolation (Biá»‡t láº­p)          â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "WEB_LINK=$WEB_URL" >> $GITHUB_ENV

      - name: â³ DUY TRÃŒ PHIÃŠN ZUNADMIN
        run: |
          for i in {1..72}; do
            echo "ğŸ’ [$(date +%H:%M:%S)] Admin Ä‘ang hoáº¡t Ä‘á»™ng... Link: $WEB_LINK"
            sleep 300
          done
