name: üöÄ VS Code Web IDX (Zun Admin Isolation)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  VSCode-ZunAdmin:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è KH·ªûI T·∫†O M√îI TR∆Ø·ªúNG ZUN (ISOLATED)
        run: |
          # 1. Thi·∫øt l·∫≠p Hostname
          sudo hostnamectl set-hostname ZunMachine
          echo "127.0.0.1 ZunMachine" | sudo tee -a /etc/hosts > /dev/null

          # 2. T·∫°o User 'Admin'
          echo "üë§ ƒêang t·∫°o User Admin..."
          sudo useradd -m -s /bin/bash Admin
          echo "Admin:Ubuntu@123456" | sudo chpasswd
          sudo usermod -aG sudo Admin

          # 3. T·∫°o ·ªï c·ª©ng ·∫£o 60GB
          echo "üíø ƒêang kh·ªüi t·∫°o ·ªï c·ª©ng 60GB..."
          sudo fallocate -l 60G /mnt/zun_storage.img
          sudo mkfs.ext4 /mnt/zun_storage.img > /dev/null 2>&1
          
          # 4. Mount ·ªï c·ª©ng v√†o ch√≠nh Home c·ªßa Admin
          # (L√†m b∆∞·ªõc n√†y ƒë·ªÉ to√†n b·ªô d·ªØ li·ªáu User n·∫±m trong ·ªï 60GB)
          sudo mount -o loop /mnt/zun_storage.img /home/Admin
          sudo chown -R Admin:Admin /home/Admin
          sudo chmod 755 /home/Admin

          # 5. C√†i ƒë·∫∑t VS Code Web (Code-Server)
          echo "üì• ƒêang c√†i ƒë·∫∑t Code-Server..."
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1

          # 6. C·∫•u h√¨nh VS Code & M√¥i tr∆∞·ªùng (Ch·∫°y d∆∞·ªõi quy·ªÅn Admin)
          sudo -u Admin mkdir -p /home/Admin/.config/code-server
          
          # T·∫°o config
          sudo -u Admin bash -c 'cat <<EOF > /home/Admin/.config/code-server/config.yaml
          bind-addr: 127.0.0.1:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF'

          # T·∫†O C·∫¢M GI√ÅC ·ªî C·ª®NG RI√äNG BI·ªÜT (Fake df -h)
          # L·ªánh n√†y s·∫Ω t·∫°o alias ƒë·ªÉ khi g√µ df -h n√≥ ch·ªâ hi·ªán ·ªï c·ªßa m√¨nh
          sudo -u Admin bash -c 'echo "alias df=\"df -h | grep -E 'Filesystem|/home/Admin'\"" >> /home/Admin/.bashrc'
          # Copy c·∫•u h√¨nh bash m·∫∑c ƒë·ªãnh v√†o ·ªï m·ªõi mount (ƒë·ªÉ c√≥ m√†u terminal ƒë·∫πp)
          sudo cp /etc/skel/.bashrc /home/Admin/
          sudo chown Admin:Admin /home/Admin/.bashrc

          # 7. Kh·ªüi ch·∫°y VS Code (Admin)
          echo "üöÄ ƒêang kh·ªüi ƒë·ªông VS Code..."
          sudo -u Admin nohup code-server > /home/Admin/code-server.log 2>&1 &

          # 8. Ch·∫°y Tunnel
          echo "üåê ƒêang thi·∫øt l·∫≠p Tunnel..."
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: üéâ TH√îNG TIN TRUY C·∫¨P (USER: ADMIN)
        run: |
          echo "üîÑ ƒêang l·∫•y li√™n k·∫øt..."
          sleep 5
          # L·ªçc l·∫•y link http
          WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          
          while [ -z "$WEB_URL" ]; do
            sleep 2
            WEB_URL=$(cat kami_tunnel.txt | grep -o 'http://[a-zA-Z0-9.-]*' | head -n 1)
          done

          # LOG M√ÄU M√à GIAO DI·ªÜN ƒê·∫∏P
          echo ""
          echo -e "\033[1;36m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\033[0m"
          echo -e "\033[1;36m‚ïë   üöÄ  VS CODE WEB IDX - ISOLATED EDITION (ZUN ADMIN)     ‚ïë\033[0m"
          echo -e "\033[1;36m‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\033[0m"
          echo -e "\033[1;36m‚ïë\033[0m \033[1;32müåê Truy c·∫≠p Web  :\033[0m \033[4;37m$WEB_URL\033[0m"
          echo -e "\033[1;36m‚ïë\033[0m \033[1;33müë§ T√†i kho·∫£n     :\033[0m Admin"
          echo -e "\033[1;36m‚ïë\033[0m \033[1;33müîê M·∫≠t kh·∫©u      :\033[0m Ubuntu@123456"
          echo -e "\033[1;36m‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£\033[0m"
          echo -e "\033[1;36m‚ïë\033[0m üíæ \033[1mDung l∆∞·ª£ng    :\033[0m 60GB (Mounted t·∫°i /home/Admin)"
          echo -e "\033[1;36m‚ïë\033[0m üõ°Ô∏è \033[1mCh·∫ø ƒë·ªô        :\033[0m User Isolation (Bi·ªát l·∫≠p)"
          echo -e "\033[1;36m‚ïë\033[0m üíª \033[1mM√°y ch·ªß       :\033[0m ZunMachine"
          echo -e "\033[1;36m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\033[0m"
          echo ""
          echo "WEB_LINK=$WEB_URL" >> $GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN ZUNADMIN
        run: |
          echo -e "\033[1;32m‚úÖ H·ªá th·ªëng ƒëang ch·∫°y ·ªïn ƒë·ªãnh.\033[0m"
          for i in {1..72}; do
            sleep 300
          done
