name: ğŸš€ VS Code Web IDX (Zun Isolation Pro)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  VSCode-Isolation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ ÄANG KHá»I Táº O MÃ”I TRÆ¯á»œNG ZUNADMIN
        run: |
          # 1. Thiáº¿t láº­p Hostname Zunadmin
          sudo hostname Zunadmin
          
          # 2. Táº¡o á»• Ä‘Ä©a áº£o 60GB biá»‡t láº­p (Sá»­a lá»—i quyá»n háº¡n)
          dd if=/dev/zero of=$HOME/zun_disk.img bs=1M count=61440 status=none
          mkfs.ext4 -q $HOME/zun_disk.img
          mkdir -p $HOME/zun_workspace
          sudo mount -o loop $HOME/zun_disk.img $HOME/zun_workspace
          sudo chown -R $USER:$USER $HOME/zun_workspace

          # 3. CÃ i Ä‘áº·t Code-Server (VS Code Web) áº©n danh
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1
          
          # 4. Cáº¥u hÃ¬nh máº­t kháº©u: Ubuntu@123456
          mkdir -p ~/.config/code-server
          cat <<EOF > ~/.config/code-server/config.yaml
          bind-addr: 0.0.0.0:8080
          auth: password
          password: Ubuntu@123456
          cert: false
          EOF

          # 5. Khá»Ÿi cháº¡y VS Code hÆ°á»›ng vÃ o á»• Zun (MÃ´i trÆ°á»ng tÃ¡ch biá»‡t)
          nohup code-server --user-data-dir $HOME/zun_workspace/.vscode-data $HOME/zun_workspace > /dev/null 2>&1 &

          # 6. Khá»Ÿi cháº¡y Kami Tunnel & Fix lá»—i IP (Port 8080)
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &

      - name: ğŸ‰ THÃ”NG TIN TRUY Cáº¬P VS CODE
        run: |
          echo "ğŸ”„ Zun x Kami Tunnel Ä‘ang thiáº¿t láº­p Ä‘Æ°á»ng truyá»n..."
          
          WEB_URL=""
          # VÃ²ng láº·p láº¥y IP thÃ´ng minh (Fix lá»—i link trá»‘ng)
          for i in {1..30}; do
            if [ -f kami_tunnel.txt ]; then
              # Lá»c chÃ­nh xÃ¡c link tá»« file log cá»§a Kami
              WEB_URL=$(grep -a -oE "https://[a-zA-Z0-9.-]+" kami_tunnel.txt | head -n 1 | sed 's|https://||')
              if [ ! -z "$WEB_URL" ]; then break; fi
            fi
            sleep 2
          done

          if [ -z "$WEB_URL" ]; then
            echo "âŒ Lá»—i: KhÃ´ng láº¥y Ä‘Æ°á»£c IP tá»« Kami Tunnel. Thá»­ láº¡i sau."
            exit 1
          fi

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘           ğŸš€ VS CODE WEB - ZUN ISOLATION ğŸš€             â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸŒ LiÃªn káº¿t Web    : http://$WEB_URL"
          echo "â•‘  ğŸ” Máº­t kháº©u        : Ubuntu@123456                      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ğŸ’¾ á»” Ä‘Ä©a Zun       : 60GB (Biá»‡t láº­p hoÃ n toÃ n)          â•‘"
          echo "â•‘  ğŸ–¥ï¸  Hostname        : Zunadmin                          â•‘"
          echo "â•‘  ğŸ‘¤ NgÆ°á»i táº¡o       : Zun x Kami Tunnel                 â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… MÃ´i trÆ°á»ng Ä‘Ã£ sáºµn sÃ ng! ChÃºc báº¡n lÃ m viá»‡c hiá»‡u quáº£."
          echo ""
          echo "WEB_LINK=http://$WEB_URL" >> $GITHUB_ENV

      - name: â³ DUY TRÃŒ PHIÃŠN ZUNADMIN
        run: |
          # Thanh tiáº¿n trÃ¬nh chuyÃªn nghiá»‡p
          for i in {1..72}; do
            current_time=$(date '+%H:%M:%S')
            echo "ğŸ’ [$current_time] Zunadmin Ä‘ang hoáº¡t Ä‘á»™ng | Link: $WEB_LINK"
            sleep 300
          done
