name: 🚀 VS Code Web IDX (Zun x Kami Tunnel)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: '🕐 Thời gian sử dụng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  VSCode-Web:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ Khởi tạo hệ thống
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq wget curl tar > /dev/null 2>&1
          
      - name: 📦 Cài đặt Code-Server
        run: |
          curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1
          
      - name: 💾 Tạo ổ đĩa ảo 60GB
        run: |
          # Tạo ổ đĩa loop với ext4
          sudo mkdir -p /mnt/workspace
          sudo truncate -s 60G /tmp/workspace.img
          sudo mkfs.ext4 -F -q /tmp/workspace.img > /dev/null 2>&1
          sudo mount -o loop /tmp/workspace.img /mnt/workspace
          sudo chown -R $USER:$USER /mnt/workspace
          
      - name: ⚙️ Cấu hình Code-Server
        run: |
          mkdir -p ~/.config/code-server
          cat > ~/.config/code-server/config.yaml << 'EOF'
          bind-addr: 127.0.0.1:8080
          auth: password
          password: 123456
          cert: false
          user-data-dir: /mnt/workspace/.vscode
          EOF
          
      - name: 🚀 Khởi động Code-Server
        run: |
          nohup code-server --user-data-dir /mnt/workspace/.vscode > /dev/null 2>&1 &
          sleep 3
          
      - name: 🌐 Khởi động Kami Tunnel
        run: |
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          nohup ./kami-tunnel 8080 > /dev/null 2>&1 &
          
      - name: 🎉 THÔNG TIN TRUY CẬP VS CODE
        run: |
          echo "⏳ Đang lấy liên kết từ Kami Tunnel..."
          for i in {1..30}; do
            if [ -f kami_tunnel.txt ]; then
              break
            fi
            sleep 2
          done
          
          if [ ! -f kami_tunnel.txt ]; then
            echo "❌ Không thể lấy liên kết tunnel"
            exit 1
          fi
          
          WEB_URL=$(cat kami_tunnel.txt | tr -d '\n\r')
          DISK_SIZE=$(df -h /mnt/workspace | awk 'NR==2 {print $2}')
          
          echo ""
          echo "════════════════════════════════════════════════════════════════════════════════"
          echo "║                                                                              ║"
          echo "║                  🚀 VS CODE WEB IDX ĐÃ SẴN SÀNG (By Zun)                     ║"
          echo "║                                                                              ║"
          echo "════════════════════════════════════════════════════════════════════════════════"
          echo ""
          echo "🌐 LIÊN KẾT TRUY CẬP:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "http://$WEB_URL"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "🔐 MẬT KHẨU:"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "123456"
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo ""
          echo "⚡ THÔNG SỐ HỆ THỐNG:"
          echo "┌────────────────────────────────────────────────────────────────────────────┐"
          echo "│ CPU             : 4 Cores Intel Xeon                                       │"
          echo "│ RAM             : 16 GB DDR4                                               │"
          echo "│ Ổ cứng          : $DISK_SIZE (Mount: /mnt/workspace)                      │"
          echo "│ Hệ điều hành    : Ubuntu 22.04 LTS                                         │"
          echo "└────────────────────────────────────────────────────────────────────────────┘"
          echo ""
          echo ""
          echo "🛠️ TÍNH NĂNG:"
          echo "┌────────────────────────────────────────────────────────────────────────────┐"
          echo "│ ✅ Full Terminal Access                                                    │"
          echo "│ ✅ Git Integration                                                         │"
          echo "│ ✅ Node.js & npm                                                           │"
          echo "│ ✅ Python 3                                                                │"
          echo "│ ✅ Extensions Support                                                      │"
          echo "│ ✅ File Upload/Download                                                    │"
          echo "└────────────────────────────────────────────────────────────────────────────┘"
          echo ""
          echo ""
          echo "📝 HƯỚNG DẪN:"
          echo "  1️⃣  Copy URL ở trên"
          echo "  2️⃣  Mở trên trình duyệt"
          echo "  3️⃣  Nhập mật khẩu: 123456"
          echo "  4️⃣  Bắt đầu code ngay!"
          echo ""
          echo ""
          echo "⚠️  LƯU Ý:"
          echo "  • Dữ liệu sẽ bị xóa khi workflow kết thúc"
          echo "  • Hãy backup code quan trọng lên Git"
          echo "  • Thời gian tối đa: ${{ github.event.inputs.duration }}"
          echo ""
          echo "════════════════════════════════════════════════════════════════════════════════"
          echo ""
          echo ""
          echo "WEB_LINK=$WEB_URL" >> $GITHUB_ENV

      - name: ⏳ Duy trì phiên làm việc
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") MAX_LOOPS=12 ;;
            "3h") MAX_LOOPS=36 ;;
            "5h40m") MAX_LOOPS=68 ;;
            *) MAX_LOOPS=68 ;;
          esac
          
          START_TIME=$(date +%s)
          
          for i in $(seq 1 $MAX_LOOPS); do
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            HOURS=$((ELAPSED / 3600))
            MINUTES=$(((ELAPSED % 3600) / 60))
            
            DISK_USED=$(df -h /mnt/workspace | awk 'NR==2 {print $3}')
            DISK_AVAIL=$(df -h /mnt/workspace | awk 'NR==2 {print $4}')
            DISK_PERCENT=$(df -h /mnt/workspace | awk 'NR==2 {print $5}')
            
            MEM_TOTAL=$(free -h | awk 'NR==2 {print $2}')
            MEM_USED=$(free -h | awk 'NR==2 {print $3}')
            MEM_PERCENT=$(free | awk 'NR==2 {printf "%.1f%%", $3/$2 * 100}')
            
            CPU_LOAD=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
            
            echo ""
            echo "┌──────────────────────────────────────────────────────────────────────────────┐"
            echo "│                                                                              │"
            echo "│  ⏰ THỜI GIAN: ${HOURS}h ${MINUTES}m | Lần kiểm tra: #${i}/${MAX_LOOPS}                         │"
            echo "│                                                                              │"
            echo "├──────────────────────────────────────────────────────────────────────────────┤"
            echo "│                                                                              │"
            echo "│  🌐 VS Code đang chạy tại:                                                   │"
            echo "│                                                                              │"
            echo "│     http://$WEB_LINK                                                         │"
            echo "│                                                                              │"
            echo "├──────────────────────────────────────────────────────────────────────────────┤"
            echo "│                                                                              │"
            echo "│  📊 TRẠNG THÁI HỆ THỐNG:                                                     │"
            echo "│                                                                              │"
            echo "│     💾 Ổ cứng    : $DISK_USED sử dụng / $DISK_AVAIL còn trống ($DISK_PERCENT)          │"
            echo "│     🧠 RAM       : $MEM_USED / $MEM_TOTAL ($MEM_PERCENT)                               │"
            echo "│     ⚡ CPU Load  : $CPU_LOAD                                                  │"
            echo "│     ✅ Trạng thái: Hoạt động bình thường                                     │"
            echo "│                                                                              │"
            echo "└──────────────────────────────────────────────────────────────────────────────┘"
            echo ""
            
            sleep 300
          done
          
          echo ""
          echo ""
          echo "════════════════════════════════════════════════════════════════════════════════"
          echo "║                                                                              ║"
          echo "║                      ⏱️  PHIÊN LÀM VIỆC ĐÃ KẾT THÚC                           ║"
          echo "║                                                                              ║"
          echo "║                                                                              ║"
          echo "║                  Thời gian sử dụng: ${{ github.event.inputs.duration }}                          ║"
          echo "║                                                                              ║"
          echo "║               Cảm ơn bạn đã sử dụng VS Code Web IDX!                         ║"
          echo "║                                                                              ║"
          echo "║                                                                              ║"
          echo "════════════════════════════════════════════════════════════════════════════════"
          echo ""
          echo ""
