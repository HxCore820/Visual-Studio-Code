name: ğŸš€ VS Code Web IDX (Zun Isolation)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  VSCode-Isolation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ ÄANG KHá»I Táº O MÃ”I TRÆ¯á»œNG ZUNADMIN
        run: |
          # ============================================
          # BÆ¯á»šC 1: Táº O á»” ÄÄ¨A áº¢O 60GB HOÃ€N TOÃ€N BIá»†T Láº¬P
          # ============================================
          
          # Táº¡o file áº£nh á»• Ä‘Ä©a 60GB
          dd if=/dev/zero of=$HOME/zun_disk.img bs=1M count=61440 status=none
          
          # Format thÃ nh ext4
          mkfs.ext4 -q $HOME/zun_disk.img
          
          # Táº¡o thÆ° má»¥c mount point
          mkdir -p $HOME/zun_workspace
          
          # Mount á»• Ä‘Ä©a áº£o
          sudo mount -o loop $HOME/zun_disk.img $HOME/zun_workspace
          sudo chown -R $USER:$USER $HOME/zun_workspace
          
          # ============================================
          # BÆ¯á»šC 2: Táº O NAMESPACE BIá»†T Láº¬P (CHROOT JAIL)
          # ============================================
          
          # CÃ i Ä‘áº·t cÃ¡c tool cáº§n thiáº¿t trong im láº·ng
          sudo apt-get update -qq > /dev/null 2>&1
          sudo apt-get install -y -qq debootstrap schroot > /dev/null 2>&1
          
          # Táº¡o mÃ´i trÆ°á»ng Ubuntu minimal trong á»• Zun
          sudo debootstrap --variant=minbase jammy $HOME/zun_workspace http://archive.ubuntu.com/ubuntu/ > /dev/null 2>&1
          
          # Cáº¥u hÃ¬nh schroot Ä‘á»ƒ cÃ´ láº­p hoÃ n toÃ n
          sudo tee /etc/schroot/chroot.d/zunadmin.conf > /dev/null <<EOF
          [zunadmin]
          description=Zun Isolated Environment
          directory=$HOME/zun_workspace
          root-users=$USER
          type=directory
          users=$USER
          preserve-environment=true
          EOF
          
          # Mount cÃ¡c filesystem cáº§n thiáº¿t vÃ o mÃ´i trÆ°á»ng biá»‡t láº­p
          sudo mount --bind /proc $HOME/zun_workspace/proc
          sudo mount --bind /sys $HOME/zun_workspace/sys
          sudo mount --bind /dev $HOME/zun_workspace/dev
          sudo mount --bind /dev/pts $HOME/zun_workspace/dev/pts
          
          # ============================================
          # BÆ¯á»šC 3: CÃ€I Äáº¶T CODE-SERVER TRONG MÃ”I TRÆ¯á»œNG BIá»†T Láº¬P
          # ============================================
          
          # CÃ i Ä‘áº·t curl vÃ  wget trong chroot
          sudo chroot $HOME/zun_workspace /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update -qq > /dev/null 2>&1
            apt-get install -y -qq curl wget > /dev/null 2>&1
          " > /dev/null 2>&1
          
          # CÃ i Ä‘áº·t code-server trong chroot
          sudo chroot $HOME/zun_workspace /bin/bash -c "
            curl -fsSL https://code-server.dev/install.sh | sh > /dev/null 2>&1
          " > /dev/null 2>&1
          
          # Táº¡o config cho code-server
          sudo chroot $HOME/zun_workspace /bin/bash -c "
            mkdir -p /root/.config/code-server
            cat > /root/.config/code-server/config.yaml <<EOL
bind-addr: 0.0.0.0:8080
auth: password
password: Ubuntu@123456
cert: false
EOL
          " > /dev/null 2>&1
          
          # ============================================
          # BÆ¯á»šC 4: Táº O SCRIPT KHá»I Äá»˜NG
          # ============================================
          
          # Script Ä‘á»ƒ cháº¡y code-server trong mÃ´i trÆ°á»ng biá»‡t láº­p
          cat > $HOME/start_zun.sh <<'SCRIPT'
          #!/bin/bash
          export HOME=/root
          cd /root
          /usr/bin/code-server --bind-addr 0.0.0.0:8080 > /dev/null 2>&1
          SCRIPT
          
          sudo cp $HOME/start_zun.sh $HOME/zun_workspace/root/
          sudo chmod +x $HOME/zun_workspace/root/start_zun.sh
          
          # Khá»Ÿi Ä‘á»™ng code-server trong chroot
          sudo chroot $HOME/zun_workspace /bin/bash -c "nohup /root/start_zun.sh &" > /dev/null 2>&1 &
          
          # Äá»£i code-server khá»Ÿi Ä‘á»™ng
          sleep 10
          
          # ============================================
          # BÆ¯á»šC 5: THIáº¾T Láº¬P KAMI TUNNEL
          # ============================================
          
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz > /dev/null 2>&1
          chmod +x kami-tunnel
          nohup ./kami-tunnel 8080 > kami_tunnel.txt 2>&1 &
          
          # Äá»£i tunnel táº¡o link
          sleep 8

      - name: ğŸ‰ THÃ”NG TIN TRUY Cáº¬P VS CODE
        run: |
          echo ""
          echo "â³ Äang thiáº¿t láº­p káº¿t ná»‘i Zun Tunnel..."
          sleep 5
          
          # Äá»c link tá»« Kami Tunnel
          if [ -f kami_tunnel.txt ]; then
            WEB_URL=$(grep -oP 'https://[^\s]+' kami_tunnel.txt | head -1 | sed 's/https:\/\///')
            if [ -z "$WEB_URL" ]; then
              WEB_URL=$(cat kami_tunnel.txt | grep -v "^$" | tail -1)
            fi
          fi
          
          # Chá» Ä‘áº¿n khi cÃ³ URL
          retry=0
          while [ -z "$WEB_URL" ] && [ $retry -lt 15 ]; do
            sleep 2
            WEB_URL=$(grep -oP 'https://[^\s]+' kami_tunnel.txt | head -1 | sed 's/https:\/\///')
            retry=$((retry+1))
          done
          
          # Hiá»ƒn thá»‹ thÃ´ng tin Ä‘áº¹p máº¯t
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘                                                          â•‘"
          echo "â•‘           ğŸš€ VS CODE WEB - ZUN ISOLATION ğŸš€             â•‘"
          echo "â•‘                                                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ğŸŒ LiÃªn káº¿t Web    : http://$WEB_URL"
          echo "â•‘  ğŸ” Máº­t kháº©u        : Ubuntu@123456                      â•‘"
          echo "â•‘                                                          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘                                                          â•‘"
          echo "â•‘  ğŸ’¾ á»” Ä‘Ä©a Zun       : 60GB (HoÃ n toÃ n biá»‡t láº­p)         â•‘"
          echo "â•‘  ğŸ–¥ï¸  Hostname        : Zunadmin                          â•‘"
          echo "â•‘  ğŸ”’ Báº£o máº­t         : Chroot Isolation + Namespace      â•‘"
          echo "â•‘  ğŸ‘¤ Táº¡o bá»Ÿi         : Zun x Kami Tunnel                 â•‘"
          echo "â•‘                                                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… MÃ´i trÆ°á»ng Ä‘Ã£ sáºµn sÃ ng! Truy cáº­p link trÃªn Ä‘á»ƒ báº¯t Ä‘áº§u."
          echo ""
          
          echo "WEB_LINK=http://$WEB_URL" >> $GITHUB_ENV

      - name: â³ DUY TRÃŒ PHIÃŠN ZUNADMIN
        run: |
          echo ""
          echo "ğŸ”„ Báº¯t Ä‘áº§u duy trÃ¬ phiÃªn lÃ m viá»‡c..."
          echo ""
          
          for i in {1..72}; do
            current_time=$(date '+%H:%M:%S')
            elapsed=$((i * 5))
            
            # Hiá»ƒn thá»‹ thanh tiáº¿n trÃ¬nh
            bar_length=30
            filled=$((elapsed * bar_length / 360))
            empty=$((bar_length - filled))
            bar=$(printf "%${filled}s" | tr ' ' 'â–ˆ')
            bar="${bar}$(printf "%${empty}s" | tr ' ' 'â–‘')"
            
            echo -ne "\rğŸ’ [$current_time] Zunadmin hoáº¡t Ä‘á»™ng [$bar] ${elapsed}m/360m"
            
            sleep 300
          done
          
          echo ""
          echo ""
          echo "âœ… PhiÃªn lÃ m viá»‡c Ä‘Ã£ káº¿t thÃºc sau 6 giá»."
