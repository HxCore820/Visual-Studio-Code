name: ğŸš€ VS Code Web IDX (Zun Isolation)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  VSCode-Isolation:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ› ï¸ ÄANG KHá»I Táº O MÃ”I TRÆ¯á»œNG TÃCH BIá»†T (ZUN DISK)
        run: |
          # 1. Táº¡o file image 60GB Ä‘á»ƒ lÃ m á»• cá»©ng áº£o
          sudo fallocate -l 60G /zun_disk.img
          sudo mkfs.ext4 /zun_disk.img > /dev/null 2>&1
          mkdir -p /mnt/zun
          sudo mount -o loop /zun_disk.img /mnt/zun
          
          # 2. Táº¡o Dockerfile Ä‘á»ƒ xÃ¢y dá»±ng mÃ´i trÆ°á»ng IDX cÃ´ láº­p
          cat <<EOF > Dockerfile
          FROM ubuntu:22.04
          RUN apt-get update && apt-get install -y curl wget git sudo && \\
              curl -fsSL https://code-server.dev/install.sh | sh
          # Táº¡o user ubuntu bÃªn trong container
          RUN useradd -m ubuntu && echo "ubuntu:Ubuntu@123456" | chpasswd && adduser ubuntu sudo
          USER ubuntu
          WORKDIR /home/ubuntu
          ENTRYPOINT ["code-server", "--bind-addr", "0.0.0.0:8080", "--auth", "password"]
          EOF

          # 3. Build vÃ  cháº¡y Container vá»›i á»• cá»©ng Zun Ä‘Æ°á»£c gáº¯n lÃ m root
          docker build -t zun-idx . > /dev/null 2>&1
          docker run -d --name zun-container \
            --storage-opt size=60G \
            -v /mnt/zun:/home/ubuntu/project \
            -p 8080:8080 \
            -e PASSWORD=Ubuntu@123456 \
            zun-idx > /dev/null 2>&1

          # 4. Táº£i vÃ  cháº¡y Kami Tunnel áº©n danh
          wget -q https://github.com/kami2k1/tunnel/releases/latest/download/kami-tunnel-linux-amd64.tar.gz
          tar -xzf kami-tunnel-linux-amd64.tar.gz
          chmod +x kami-tunnel
          ./kami-tunnel 8080 > /dev/null 2>&1 &

      - name: ğŸ‰ THÃ”NG TIN TRUY Cáº¬P VS CODE (ZUN DISK)
        run: |
          echo "ğŸ”„ Äang kiá»ƒm tra á»• cá»©ng Zun 60GB..."
          while [ ! -f kami_tunnel.txt ]; do sleep 2; done
          WEB_URL=$(cat kami_tunnel.txt)
          
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚        ğŸš€ VS CODE WEB IDX - ZUN ISOLATION          â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸŒ LiÃªn káº¿t Web: http://$WEB_URL"
          echo "â”‚ ğŸ” Máº­t kháº©u    : Ubuntu@123456"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "â”‚ ğŸ› ï¸  á»” cá»©ng riÃªng: 60GB (Mount: /home/ubuntu/project)â”‚"
          echo "â”‚ ğŸ“Š Lá»‡nh kiá»ƒm tra: df -h | grep project             â”‚"
          echo "â”‚ ğŸ‘¤ NgÆ°á»i táº¡o   : Zun x Kami Tunnel                 â”‚"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "WEB_LINK=$WEB_URL" >> $GITHUB_ENV

      - name: â³ DUY TRÃŒ PHIÃŠN IDX
        run: |
          for i in {1..72}; do
            echo "ğŸ’ [$(date +%H:%M:%S)] IDX Zun Disk Ä‘ang hoáº¡t Ä‘á»™ng."
            sleep 300
          done
